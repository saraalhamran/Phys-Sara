<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PS70: Intro to Digital Fabrication — Machine Building</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../style.css" rel="stylesheet">
  <style>
    /* Keep natural image proportions */
    img.img-card { width: 100%; height: auto; display: block; }
    figure { margin: 0 0 1rem 0; }

    /* Make the FIRST five big, single images a little smaller */
    .shrink {
      max-width: 900px; /* tweak this number if you want more/less shrink */
      margin: 0 auto;   /* center within the page */
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- Top Header (colors unchanged) -->
  <nav class="navbar navbar-expand-sm navbar-dark" style=" color: #EEE7E8;">
    <div class="container-fluid" style="align-items: center; justify-content: center;">
      <div class="flexrow">
        <h2 class="nav-title">Digital Fabrication - Summer 2025</h2>
      </div>
      <div class="navbar-nav">
        <h4><a class="nav-link" href="../index.html">Home</a></h4>
        <h4><a class="nav-link" href="../about.html">About</a></h4>
      </div>
    </div>
  </nav>

  <main class="container py-4 page">
    <header class="mb-3">
      <h3>Weeks 10–12: Machine Building</h3>
    </header>

    <!-- Assembling Materials -->
    <section aria-label="Assembling Materials">
      <h4>Assembling Materials</h4>
      <div class="row gallery-gap">
        <div class="col-12">
          <figure class="shrink"><img src="./1.png" alt="Removing supports from 3D prints" class="img-card img-fluid" loading="lazy"></figure>
        </div>
      </div>
      <p class="h6 lh-base">We started by removing the supports from the 3D-printed green structural parts given to us. You can see the remaining support material lodged in narrow holes and tight corners, which made the task especially tedious. This was the moment we realized that tweezers were not strong enough to be effective. Instead, we started using plastic cutters for thicker support pieces and metal pokers to reach deep into the screw holes and crevices.</p>
    </section>

    <!-- First Steps -->
    <section aria-label="First Steps">
      <h4>First Steps</h4>
      <div class="row gallery-gap">
        <div class="col-12">
          <figure class="shrink"><img src="./2.png" alt="Laid out parts for planning" class="img-card img-fluid" loading="lazy"></figure>
        </div>
      </div>
      <p class="h6 lh-base">After removing all the supports, we organized the 3D-printed parts on the table to assess what we had. We were trying to understand the function of each part, where gears would go, how the belt would loop around the system, and how to support the overall frame. Without instructions, we assembled the basic parts relying on various reference images we found online. This was also when we began to brainstorm how to make our machine draw using more than one pen.</p>
    </section>

    <!-- Screwing Components -->
    <section aria-label="Screwing Components">
      <h4>Screwing Components</h4>
      <div class="row gallery-gap">
        <div class="col-12">
          <figure class="shrink"><img src="./3.png" alt="Fitting frame and gears with screws" class="img-card img-fluid" loading="lazy"></figure>
        </div>
      </div>
      <p class="h6 lh-base">We had just started testing how the frame and gears were supposed to fit together. One of the most frustrating parts was figuring out which screws worked with which holes. Some were too short, others were too wide, and we kept going back and forth swapping them out to see what would actually hold the parts together. It took a lot of patience and guessing to get it right, especially with the gears—since they needed to be secure but still able to rotate freely. Even though it was a struggle, we were finally starting to see the machine come to life.</p>
    </section>

    <!-- Timing Belt -->
    <section aria-label="Timing Belt">
      <h4>Timing Belt</h4>
      <div class="row gallery-gap">
        <div class="col-12">
          <figure class="shrink"><img src="./4.png" alt="Routing and tensioning the timing belt" class="img-card img-fluid" loading="lazy"></figure>
        </div>
      </div>
      <p class="h6 lh-base">This was a tricky process as the belt kept slipping off or not aligning properly with the gears. We had to keep adjusting the position of the motor and tensioning the belt so that it would stay on track without skipping. It was also hard to tell at first how tight the belt was supposed to be: too loose and it would not move, too tight and it would strain the motor. It was frustrating, but it helped us understand how precise things need to be when working with moving parts.</p>
    </section>

    <!-- Belt Problems -->
    <section aria-label="Belt Problems">
      <h4>Belt Problems</h4>
      <div class="row gallery-gap">
        <div class="col-12">
          <figure class="shrink"><img src="./5.png" alt="Belt skipping and base stability issues" class="img-card img-fluid" loading="lazy"></figure>
        </div>
      </div>
      <p class="h6 lh-base">We were testing how well the belt moved once everything was assembled. While it was exciting to see parts of the machine moving, we quickly ran into more problems. The belt kept skipping steps, and sometimes it would not grip properly at all. We realized part of the issue was not securing the base of the machine, as it kept shifting around when the motor started running. This made everything shake, which messed up the motion of the belt. It was a bit discouraging after all the work we had done to align everything. Still, it helped us realize that we needed to focus not just on the parts themselves, but also on how the machine sits on the surface.</p>

      <div class="row gallery-gap">
        <div class="col-12 col-md-6">
          <figure><img src="./6.png" alt="More belt alignment" class="img-card img-fluid" loading="lazy"></figure>
        </div>
        <div class="col-12 col-md-6">
          <figure><img src="./62.png" alt="Continuing belt tension fixes" class="img-card img-fluid" loading="lazy"></figure>
        </div>
      </div>
      <p class="h6 lh-base">The belts took up more time than they should have, and we kept on facing countless struggles with them, but shoutout to Bobby for helping us!</p>
    </section>

    <!-- 3D Printing: 3 pens -->
    <section aria-label="3D Printing — 3 Pens">
      <h4>3D Printing: 3 pens</h4>
      <div class="row gallery-gap">
        <div class="col-12">
          <figure><img src="./7.png" alt="Concept for triple-pen drawing" class="img-card img-fluid" loading="lazy"></figure>
        </div>
      </div>
      <p class="h6 lh-base">Our plan was to have our art machine draw using three pens at once. The idea was to create a more complex output by moving multiple pens together across the page. Looking back, it was a really ambitious goal, and honestly, not very well thought of at the time. We did not fully consider how we would control the movement of three pens accurately or how that would affect the belt tension and frame stability. It sounded cool in theory, but we lacked a clear plan for its mechanics or code. This part of the project taught us a lot about the difference between creative ideas and technical feasibility. While we did not fully achieve the triple-pen system, experimenting with it pushed us to be more thoughtful about design limitations and realistic goals.</p>
    </section>

    <!-- More Assembling -->
    <section aria-label="More Assembling">
      <h4>More Assembling</h4>
      <div class="row gallery-gap">
        <div class="col-12 col-md-4"><figure><img src="./81.png" alt="Assembly step 1" class="img-card img-fluid" loading="lazy"></figure></div>
        <div class="col-12 col-md-4"><figure><img src="./82.png" alt="Assembly step 2" class="img-card img-fluid" loading="lazy"></figure></div>
        <div class="col-12 col-md-4"><figure><img src="./83.png" alt="Assembly step 3" class="img-card img-fluid" loading="lazy"></figure></div>
      </div>
      <p class="h6 lh-base">We hot glued the stepper motors onto both sides of the black base, making sure they were aligned with the gear system. Once the motors were secured in place, we attached the central moving platform (the green part that holds the pen) on top of the frame. This piece was carefully placed so that it could slide smoothly along the X-axis, guided by the belt and supported by the pulleys driven by the motor.</p>
    </section>

    <!-- Circuit -->
    <section aria-label="Circuit">
      <h4>Circuit</h4>
      <div class="row gallery-gap">
        <div class="col-12">
          <figure><img src="./9.png" alt="Breadboard wiring and driver" class="img-card img-fluid" loading="lazy"></figure>
        </div>
      </div>
      <p class="h6 lh-base">Everything was connected to the breadboard, including the motor driver, microcontroller, power source, and jumper wires. At this stage, things looked pretty messy, and getting all the connections right took a lot of patience. One major challenge we ran into was that only one team member had been fully in charge of the circuit wiring. So when they were not present, the rest of us did not know what each wire did or where it was supposed to go. That experience taught us something really important: labeling wires and creating a clear wiring diagram is essential. It would have saved us a lot of time and confusion if we had made even a simple chart showing what connected where. Having a visual guide makes debugging easier and helps everyone on the team stay on the same page.</p>
    </section>

    <!-- First Test -->
    <section aria-label="First Test">
      <h4>First Test!</h4>
      <div class="row gallery-gap">
        <div class="col-12">
          <figure class="mb-2">
            <video class="img-card" width="100%" height="auto" controls>
              <source src="./10.mov" type="video/quicktime">
              Your browser does not support the video tag.
            </video>
          </figure>
        </div>
      </div>
      <p class="h6 lh-base">In this video, the drawing machine is performing its first successful test run. The pen is not yet attached but you can see the belt driving the motion smoothly, which means the motor works just fine. Even though this was not the biggest step ever, it was for us! It was proof that our circuitry, or at least parts of it, were correct.</p>
    </section>

    <!-- Progress -->
    <section aria-label="Progress">
      <h4>Progress</h4>
      <div class="row gallery-gap">
        <div class="col-12">
          <figure><img src="./11.png" alt="Machine nearing completion" class="img-card img-fluid" loading="lazy"></figure>
        </div>
      </div>
      <p class="h6 lh-base">As we neared the end, a few issues slowed us down. The belt kept slipping, so we had to adjust its tension several times. We also found that the X-axis carriage was not hitting the limit switch properly, which made alignment difficult and delayed progress. Another major setback was burning our first microcontroller, likely due to a wiring mistake. Overall, even though we did not get to implement every feature we planned, we learned a lot about troubleshooting, teamwork, and the importance of clear documentation.</p>
    </section>

    <!-- Code -->
    <section aria-label="Code">
      <h4>Here is our code!</h4>
      <pre><code>#include &lt;WiFi.h&gt;
#include &lt;AsyncTCP.h&gt;
#include &lt;ESPAsyncWebServer.h&gt;
#include &lt;AccelStepper.h&gt;
#include &lt;ESP32Servo.h&gt;
// Define a stepper and the pins it will use
//AccelStepper stepper_X1(1, 9, 10); // initialise accelstepper for a two wire board
//AccelStepper stepper_X2(1, 11, 12); // initialise accelstepper for a two wire board
//AccelStepper stepper_Y(1, 13, 14); // initialise accelstepper for a two wire board

AccelStepper stepper_Y(1, 21, 19); // initialise accelstepper for a two wire board
//AccelStepper stepper_X2(1, 14, 12); // initialise accelstepper for a two wire board
AccelStepper stepper_X(1, 22, 23); // initialise accelstepper for a two wire board

// Replace with your network credentials
const char* ssid = "MAKERSPACE";
const char* password = "12345678";

Servo myservo;

/*const int A1A = 32;  // define pin 12 for A-1A (PWM Speed)
const int A1B = 35;

const int freq = 5000;
const int resolution = 8;*/

String message = "";

// Create AsyncWebServer object on port 80
AsyncWebServer server(80);
AsyncWebSocket ws("/ws");

//Variables to save values from HTML form
String steps_X;
String steps_Y;
int penDown = 0;
bool newRequest = false;

int pos;


const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
<head>
  <title>Sidewalk Plotter Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <div class="topnav">
    <h3>Sidewalk Plotter Control</h3>
  </div>
  <div class="content">
      <canvas id="canvas" width="600" height="400" style="border: 1px solid black;">
          Your browser does not support the HTML 5 Canvas.
      </canvas>
      <label class="switch">
        <input type="checkbox" onclick="togglePen()">
        <span class="slider round">Pen Down</span>
      </label>
  </div>
</body>
<script>
var gateway = `ws://${window.location.hostname}/ws`;
var websocket;
window.addEventListener('load', onload);
var dir;
var pointsX = [];
var pointsY = [];
var penDown = 0;

var canvas = document.querySelector('canvas'),
    ctx = canvas.getContext('2d');

ctx.lineWidth = 2;
ctx.strokeStyle = 'red';

//report the mouse position on click
canvas.addEventListener("click", function (evt) {
  var mousePos = getMousePos(canvas, evt);
  if (penDown == 0){
    pointsX.pop();
    pointsY.pop();
  }
 
  pointsX.push(mousePos.x);
  pointsY.push(mousePos.y);

  websocket.send(mousePos.x+"&"+mousePos.y+"-"+penDown);
  ctx.beginPath();
  for (var i = 0; i < pointsX.length; i++){
    ctx.lineTo(pointsX[i], pointsY[i]);
  }
  ctx.stroke();    
}, false);

//Get Mouse Position
function getMousePos(canvas, evt) {
    var rect = canvas.getBoundingClientRect();
    return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
    };
}

function togglePen(){
  if (penDown == 0){
    penDown = 1;
  } else {
    penDown = 0;
  }
  console.log(penDown);
}

function onload(event) {
    initWebSocket();
}

function initWebSocket() {
    console.log('Trying to open a WebSocket connection…');
    websocket = new WebSocket(gateway);
    websocket.onopen = onOpen;
    websocket.onclose = onClose;
    websocket.onmessage = onMessage;
}

function onOpen(event) {
    console.log('Connection opened');
}

function onClose(event) {
    console.log('Connection closed');
    setTimeout(initWebSocket, 2000);
}

function onMessage(event) {
    console.log(event.data);
}
</script>
</html>
)rawliteral";

// Initialize WiFi
void initWiFi() {
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi ..");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print('.');
    delay(1000);
  }
  Serial.println(WiFi.localIP());
  Serial.println("above");
}

void handleWebSocketMessage(void *arg, uint8_t *data, size_t len) {
  AwsFrameInfo *info = (AwsFrameInfo*)arg;
  if (info->final && info->index == 0 && info->len == len && info->opcode == WS_TEXT) {
    data[len] = 0;
    message = (char*)data;
    steps_X = message.substring(0, message.indexOf("&"));
    steps_Y = message.substring(message.indexOf("&") + 1, message.indexOf("-"));
    penDown = message.substring(message.indexOf("-") + 1, message.length()).toInt();
    Serial.print("steps_X: ");
    Serial.println(steps_X);
    Serial.print("steps_Y: ");
    Serial.println(steps_Y);
    Serial.print("pen down: ");
    Serial.println(penDown);
    newRequest = true;
  }
}

void onEvent(AsyncWebSocket *server, AsyncWebSocketClient *client, AwsEventType type, void *arg, uint8_t *data, size_t len) {
  switch (type) {
    case WS_EVT_CONNECT:
      Serial.printf("WebSocket client #%u connected from %s\n", client->id(), client->remoteIP().toString().c_str());
      break;
    case WS_EVT_DISCONNECT:
      Serial.printf("WebSocket client #%u disconnected\n", client->id());
      break;
    case WS_EVT_DATA:
      handleWebSocketMessage(arg, data, len);
      break;
    case WS_EVT_PONG:
    case WS_EVT_ERROR:
      break;
  }
}

void initWebSocket() {
  ws.onEvent(onEvent);
  server.addHandler(&ws);
}

String processor(const String& var) {
  Serial.println("PROCESSOR");
  Serial.println(var);
  if (var == "STATE") {
    return "OFF";
  }
  return String();
}

void setup() {
  Serial.begin(115200);
  initWiFi();
  initWebSocket();
  myservo.attach(4);

  pinMode(5, INPUT_PULLUP);
  pinMode(18, INPUT_PULLUP);

  server.on("/", HTTP_GET, [](AsyncWebServerRequest * request) {
    request->send_P(200, "text/html", index_html, processor);
  });

  server.begin();

  stepper_X.setMaxSpeed(1000.0);
  stepper_X.setAcceleration(1000.0);

  stepper_Y.setMaxSpeed(1000.0);
  stepper_Y.setAcceleration(1000.0);

  home();
}

void loop() {
  if (newRequest) {
    if (penDown == 0) {
      mPenUp();
    }
    else {
      mPenDown();
    }
    stepper_X.moveTo(steps_X.toInt());
    stepper_Y.moveTo(steps_Y.toInt());
    Serial.println("new");
    Serial.println(steps_X.toInt());
    newRequest = false;
    ws.cleanupClients();
  }

  if (stepper_X.distanceToGo() == 0 && stepper_Y.distanceToGo() == 0) {
    // idle
  }

  stepper_X.run();
  stepper_Y.run();
}

void mPenUp() {
  for (pos = 90; pos <= 180; pos++) {
    myservo.write(pos);
    delay(15);
  }
}

void mPenDown() {
  for (pos = 180; pos >= 90; pos--) {
    myservo.write(pos);
    delay(15);
  }
}

void home() {
  int home = 100;
  while (digitalRead(5)) {
    stepper_X.moveTo(home);
    stepper_X.run();
    home += 1;
    delay(15);
  }
  stepper_X.setCurrentPosition(0);
}
</code></pre>
    </section>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
